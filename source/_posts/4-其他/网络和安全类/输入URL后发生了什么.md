

# 输入URL后发生了什么?

从耗时上看，经历了DNS解析，TCP连接，HTTP请求与响应，客户端浏览器解析渲染，连接结束



1. 浏览器查找当前URL是否存在缓存，并比较缓存是否过期;
2. DNS解析URL对应的IP;
3. 根据IP建立TCP连接（三次握手）;
4. HTTP发起请求;
5. 服务器处理请求，浏览器接收http响应;
6. 渲染页面，构建DOM树;
7. 关闭TCP连接（四次挥手）;
 




# 2.DNS解析

把域名解析为IP地址的过程


# 3.TCP连接 - 俗称的三次握手

TCP连接的重要目的，是为了消息传播的有序和不丢失，为了==建立可靠的数据传输==。确保已经建立连接再开始传递数据
TCP通信双方互相告知初始化序列号，并确定对方已经收到ISN，再开始传递数据


1. 客户端发送一个syn包到服务器，并进入SYN_SEND状态；
2. 服务器端收到之后，发送一个确认包，表示自己收到了客户端的包，此时进入SYN_RECV状态；
3. 客户端在发送一个确认收ACK到服务器，此时进入ESTABLISHED状态；



# HTTP请求与响应

HTTP请求，主要发生在客户端，发送HTTP请求的过程就是构建HTTP请求报文，并通过TCP协议发送到服务器指定端口的过程
- 当在地址栏输了地址后，浏览器就开始解析这个地址并设置请求报文，请求报文包括
   - 请求行（包含请求的路径、方法和协议版本），
   - 请求头（包含请求的一些附加信息，一般是以键值对的形式存在），
   - 空行（协议中规定请求头和请求主体之间必须用一个空行隔开），
   - 请求体（对于post请求，参数都不会拼在url上，这时候就需要一个载体，这个载体就是请求主体）
- 当服务器收到这个请求后，会根据url匹配到的路径做相应的处理，返回浏览器请求的页面资源
- 处理之后，浏览器会收到一个响应报文，与请求报文对应的，响应报文包含
   - 起始行（响应报文的起始行同样包含了协议版本，与请求行不同的是还包含了响应状态码和状态码的原因短语），
   - 响应头（对应请求报文中的请求头，格式一致，但是各自有各自不同的首部），
   - 空行；
   - 响应主体（请求需要的资源），不同的地方在于包含的内容不同




# 客户端浏览器解析渲染


包括HTML词法、语法的解析，CSS解析，DOM树生成，渲染树建立，屏幕绘制：
- 重绘，页面的一部分重新绘制，不影响整体布局，比如某个CSS的背景色变了，但元素的几何尺寸和位置不变
- 重排，意味着元件的几何尺寸变了，需要重新验证并计算渲染树，是渲染树的一部分或者全部发生了变化
- 无论是重绘，重排，都是浏览器性能的一种消耗，应该尽量避免这种情况









# 四次挥手

由于TCP连接是==全双工==的，因此每个方向都必须单独进行关闭。
原则是当一方完成它的数据发送任务后就能发送一个FIN来终止这个方向的连接。收到一个 FIN只意味着这一方向上没有数据流动，一个TCP连接在收到一个FIN后仍能发送数据。首先进行关闭的一方将执行主动关闭，而另一方执行被动关闭。

（1） TCP客户端发送一个FIN，用来关闭客户到服务器的数据传送。
（2） 服务器收到这个FIN，它发回一个ACK，确认序号为收到的序号加1。
（3） 服务器关闭客户端的连接，发送一个FIN给客户端。
（4） 客户端发回ACK报文确认，并将确认序号设置为收到序号加1
